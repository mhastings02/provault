<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Simplified CSP without font-src since we're hosting Font Awesome locally -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; connect-src 'self';">
  <title>PromptVault Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .prompt-enter {
      animation: slideIn 0.3s ease-in;
    }
    @keyframes slideIn {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .toast {
      animation: fadeInOut 3s ease-in-out;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(20px); }
    }
    .draggable.dragging {
      opacity: 0.5;
      background: #e0e7ff;
    }
    .sidebar {
      transition: transform 0.3s ease-in-out;
    }
    [data-theme="dark"] {
      background: #1f2937;
      color: #e5e7eb;
    }
    [data-theme="dark"] .bg-white { background: #374151; }
    [data-theme="dark"] .bg-gray-50 { background: #4b5563; }
    [data-theme="dark"] .text-gray-900 { color: #e5e7eb; }
    [data-theme="dark"] .border-gray-300 { border-color: #6b7280; }
    [data-theme="dark"] canvas { background: #374151; }
  </style>
</head>
<body class="bg-gray-100 font-sans transition-colors duration-200" data-theme="light">
  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white p-4 rounded-md shadow-lg hidden toast" role="alert"></div>

  <!-- Iframe Warning -->
  <div id="iframeWarning" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
    <div class="bg-white p-4 rounded-md shadow-lg max-w-md w-full text-center">
      <p class="text-red-600 font-semibold">This page cannot be loaded in an iframe.</p>
      <p>Please open it directly in a browser window to use PromptVault Pro.</p>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loading" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
    <div class="bg-white p-4 rounded-md shadow-lg">
      <p>Loading PromptVault Pro... Please wait.</p>
    </div>
  </div>

  <!-- Main Content -->
  <div id="appContainer"></div>

  <script>
    (function() {
      // Check if the page is being loaded in an iframe
      if (window.self !== window.top) {
        document.getElementById('iframeWarning').classList.remove('hidden');
        return;
      }

      // Utility Functions
      function showToast(message, bgColor = 'bg-green-500') {
        try {
          const toast = document.getElementById('toast');
          if (!toast) throw new Error('Toast element not found');
          toast.textContent = message;
          toast.className = `fixed bottom-4 right-4 text-white p-4 rounded-md shadow-lg ${bgColor} toast`;
          toast.classList.remove('hidden');
          setTimeout(() => toast.classList.add('hidden'), 3000);
        } catch (e) {
          console.error('Error showing toast:', e);
        }
      }

      // Debounced localStorage Operations
      const localStorageQueue = new Map();
      function safeGetItem(key, defaultValue) {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : defaultValue;
        } catch (e) {
          console.error(`Error reading ${key} from localStorage:`, e);
          return defaultValue;
        }
      }

      function safeSetItem(key, value) {
        try {
          localStorageQueue.set(key, value);
          debounceSaveToLocalStorage();
        } catch (e) {
          console.error(`Error queuing ${key} for localStorage:`, e);
        }
      }

      const debounceSaveToLocalStorage = debounce(() => {
        for (const [key, value] of localStorageQueue.entries()) {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch (e) {
            console.error(`Error writing ${key} to localStorage:`, e);
            showToast('Storage error occurred.', 'bg-red-500');
          }
        }
        localStorageQueue.clear();
      }, 500);

      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Check Authentication
      let user = safeGetItem('user', null);
      if (!user || !user.name) {
        showToast('Please log in to access PromptVault Pro.', 'bg-yellow-500');
        setTimeout(() => window.location.href = 'login.html', 2000);
        return;
      }

      // Show Loading Indicator
      const loading = document.getElementById('loading');
      loading.classList.remove('hidden');

      // Timeout Safeguard
      const renderTimeout = setTimeout(() => {
        loading.classList.add('hidden');
        showToast('Page took too long to load. Please refresh and try again.', 'bg-red-500');
      }, 10000); // 10-second timeout

      // Inject Main Content
      const appContainer = document.getElementById('appContainer');
      try {
        appContainer.innerHTML = `
          <!-- Navbar -->
          <nav class="bg-indigo-700 text-white p-4 flex items-center justify-between shadow-md">
            <div class="flex items-center">
              <span class="text-xl font-semibold">PromptVault Pro</span>
            </div>
            <div class="flex items-center space-x-4">
              <button id="themeToggle" class="text-yellow-300 hover:text-yellow-400" aria-label="Toggle dark mode"><i class="fas fa-moon"></i></button>
              <button id="apiSettingsBtn" class="text-blue-300 hover:text-blue-400" aria-label="API settings"><i class="fas fa-cog"></i></button>
              <button id="supportBtn" class="text-green-300 hover:text-green-400 hidden" aria-label="Contact support"><i class="fas fa-headset"></i></button>
              <span id="userGreeting" class="hidden md:block">Welcome, <span id="userName"></span></span>
              <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition duration-200">Logout</button>
            </div>
          </nav>

          <!-- Main Layout -->
          <div class="flex max-w-6xl mx-auto mt-8">
            <aside id="sidebar" class="w-64 bg-gray-50 p-4 rounded-lg shadow-md mr-4 hidden">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Team Prompts</h3>
                <button id="toggleSidebar" class="text-gray-500 hover:text-gray-700" aria-label="Toggle sidebar"><i class="fas fa-chevron-left"></i></button>
              </div>
              <ul id="teamPromptList" class="space-y-2 mb-4" role="list"></ul>
              <h3 class="text-lg font-semibold mb-2">Team Activity</h3>
              <ul id="teamActivityList" class="space-y-2" role="list"></ul>
            </aside>
            <main class="flex-1 p-6 bg-white rounded-lg shadow-lg">
              <h2 class="text-2xl font-bold text-center mb-6">Your Prompt Vault</h2>
              <div id="proBanner" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6 hidden" role="alert">
                <p class="font-semibold">ðŸ”’ Unlock Pro to Access Premium Features!</p>
                <button onclick="window.location.href='upgrade.html'" class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md">Upgrade to Pro</button>
              </div>
              <div id="analyticsDashboard" class="bg-indigo-50 p-4 mb-6 rounded-md hidden">
                <h3 class="text-lg font-semibold mb-2">Prompt Analytics</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                  <p>Total Prompts: <span id="totalPrompts">0</span></p>
                  <p>Team Prompts: <span id="teamPrompts">0</span></p>
                  <p>Most Used Category: <span id="topCategory">None</span></p>
                </div>
                <canvas id="promptTrendChart" class="max-h-64"></canvas>
              </div>
              <div id="fetchPromptsSection" class="bg-blue-50 p-4 mb-6 rounded-md hidden">
                <h3 class="text-lg font-semibold mb-2">Fetch AI Prompts</h3>
                <div id="fetchPromptForm" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                  <input id="fetchQuery" type="text" placeholder="Enter query for AI prompt" class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Enter query for AI prompt" />
                  <select id="aiSource" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Select AI source">
                    <option value="grok">Grok</option>
                    <option value="chatgpt">ChatGPT</option>
                  </select>
                  <button id="fetchPromptBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200">Fetch Prompts</button>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row justify-between mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                <input id="searchInput" type="text" placeholder="Search prompts..." class="w-full sm:w-1/2 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Search prompts" />
                <select id="categoryFilter" class="w-full sm:w-1/4 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Filter by category">
                  <option value="">All Categories</option>
                  <option value="Work">Work</option>
                  <option value="Personal">Personal</option>
                  <option value="Team">Team</option>
                </select>
                <div class="flex space-x-2">
                  <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">Export</button>
                  <label for="importInput" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md cursor-pointer">Import</label>
                  <input id="importInput" type="file" accept=".json" class="hidden" />
                </div>
              </div>
              <div id="customCategoriesSection" class="bg-green-50 p-4 mb-6 rounded-md hidden">
                <h3 class="text-lg font-semibold mb-2">Manage Categories</h3>
                <div id="categoryForm" class="flex space-x-4">
                  <input id="newCategoryInput" type="text" placeholder="Enter new category" class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Enter new category" />
                  <button id="addCategoryBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition duration-200">Add Category</button>
                </div>
                <ul id="categoryList" class="mt-4 space-y-2"></ul>
              </div>
              <div id="promptForm" class="flex flex-col sm:flex-row mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                <input id="promptInput" type="text" placeholder="Enter your prompt..." required class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Enter prompt" />
                <select id="categoryInput" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Select category">
                  <option value="Work">Work</option>
                  <option value="Personal">Personal</option>
                  <option value="Team">Team</option>
                </select>
                <input id="teamTagInput" type="text" placeholder="Tag team member (Pro)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 hidden" aria-label="Tag team member" />
                <button id="savePromptBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition duration-200">Save Prompt</button>
              </div>
              <ul id="promptList" class="space-y-4" role="list"></ul>
            </main>
          </div>

          <!-- Modals -->
          <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg max-w-md w-full">
              <h3 class="text-lg font-semibold mb-4">Prompt History</h3>
              <ul id="historyList" class="space-y-2 max-h-64 overflow-y-auto"></ul>
              <button id="closeHistoryBtn" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Close</button>
            </div>
          </div>
          <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg max-w-lg w-full">
              <h3 class="text-lg font-semibold mb-4">AI Prompt Suggestions</h3>
              <ul id="previewList" class="space-y-4 max-h-64 overflow-y-auto"></ul>
              <div class="flex justify-end space-x-2 mt-4">
                <button id="closePreviewBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Cancel</button>
                <button id="saveAIPrompts" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md">Save Selected</button>
              </div>
            </div>
          </div>
          <div id="apiSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg max-w-md w-full">
              <h3 class="text-lg font-semibold mb-4">API Settings</h3>
              <div id="apiSettingsForm" class="space-y-4">
                <div>
                  <label for="grokApiKey" class="block text-sm font-medium">Grok API Key</label>
                  <input id="grokApiKey" type="password" placeholder="Enter Grok API key" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Grok API key" />
                </div>
                <div>
                  <label for="chatgptApiKey" class="block text-sm font-medium">ChatGPT API Key</label>
                  <input id="chatgptApiKey" type="password" placeholder="Enter ChatGPT API key" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="ChatGPT API key" />
                </div>
                <div class="flex justify-end space-x-2">
                  <button id="closeApiSettingsBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Cancel</button>
                  <button id="saveApiSettingsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md">Save</button>
                </div>
              </div>
            </div>
          </div>
          <div id="supportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg max-w-md w-full">
              <h3 class="text-lg font-semibold mb-4">Contact Priority Support</h3>
              <div id="supportForm" class="space-y-4">
                <div>
                  <label for="supportIssue" class="block text-sm font-medium">Describe Your Issue</label>
                  <textarea id="supportIssue" placeholder="Enter issue details" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Describe issue" rows="4"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                  <button id="closeSupportBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Cancel</button>
                  <button id="submitSupportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">Submit</button>
                </div>
              </div>
            </div>
          </div>
        `;
      } catch (e) {
        clearTimeout(renderTimeout);
        loading.classList.add('hidden');
        console.error('Error injecting content:', e);
        showToast('Failed to load the application. Please try again.', 'bg-red-500');
        return;
      }

      // Data Management
      let prompts = safeGetItem('prompts', []);
      let apiKeys = safeGetItem('apiKeys', { grok: '', chatgpt: '' });
      let categories = safeGetItem('categories', ['Work', 'Personal', 'Team']);
      let teamActivity = safeGetItem('teamActivity', []);

      // DOM Elements
      const elements = {
        promptForm: document.getElementById('promptForm'),
        promptInput: document.getElementById('promptInput'),
        categoryInput: document.getElementById('categoryInput'),
        teamTagInput: document.getElementById('teamTagInput'),
        promptList: document.getElementById('promptList'),
        teamPromptList: document.getElementById('teamPromptList'),
        teamActivityList: document.getElementById('teamActivityList'),
        proBanner: document.getElementById('proBanner'),
        searchInput: document.getElementById('searchInput'),
        categoryFilter: document.getElementById('categoryFilter'),
        userNameSpan: document.getElementById('userName'),
        userGreeting: document.getElementById('userGreeting'),
        exportBtn: document.getElementById('exportBtn'),
        importInput: document.getElementById('importInput'),
        themeToggle: document.getElementById('themeToggle'),
        sidebar: document.getElementById('sidebar'),
        toggleSidebar: document.getElementById('toggleSidebar'),
        analyticsDashboard: document.getElementById('analyticsDashboard'),
        totalPrompts: document.getElementById('totalPrompts'),
        teamPrompts: document.getElementById('teamPrompts'),
        topCategory: document.getElementById('topCategory'),
        promptTrendChart: document.getElementById('promptTrendChart')?.getContext('2d'),
        historyModal: document.getElementById('historyModal'),
        historyList: document.getElementById('historyList'),
        fetchPromptsSection: document.getElementById('fetchPromptsSection'),
        fetchPromptForm: document.getElementById('fetchPromptForm'),
        fetchQuery: document.getElementById('fetchQuery'),
        aiSource: document.getElementById('aiSource'),
        apiSettingsBtn: document.getElementById('apiSettingsBtn'),
        apiSettingsModal: document.getElementById('apiSettingsModal'),
        apiSettingsForm: document.getElementById('apiSettingsForm'),
        grokApiKey: document.getElementById('grokApiKey'),
        chatgptApiKey: document.getElementById('chatgptApiKey'),
        supportBtn: document.getElementById('supportBtn'),
        supportModal: document.getElementById('supportModal'),
        supportForm: document.getElementById('supportForm'),
        supportIssue: document.getElementById('supportIssue'),
        previewModal: document.getElementById('previewModal'),
        previewList: document.getElementById('previewList'),
        saveAIPrompts: document.getElementById('saveAIPrompts'),
        customCategoriesSection: document.getElementById('customCategoriesSection'),
        categoryForm: document.getElementById('categoryForm'),
        newCategoryInput: document.getElementById('newCategoryInput'),
        categoryList: document.getElementById('categoryList'),
        logoutBtn: document.getElementById('logoutBtn'),
        closeHistoryBtn: document.getElementById('closeHistoryBtn'),
        closePreviewBtn: document.getElementById('closePreviewBtn'),
        closeApiSettingsBtn: document.getElementById('closeApiSettingsBtn'),
        saveApiSettingsBtn: document.getElementById('saveApiSettingsBtn'),
        closeSupportBtn: document.getElementById('closeSupportBtn'),
        submitSupportBtn: document.getElementById('submitSupportBtn'),
        addCategoryBtn: document.getElementById('addCategoryBtn'),
        savePromptBtn: document.getElementById('savePromptBtn'),
        fetchPromptBtn: document.getElementById('fetchPromptBtn')
      };

      // Initialize UI
      function initializeUI() {
        try {
          elements.userNameSpan.textContent = user.name;
          elements.userGreeting.classList.remove('hidden');

          if (!user.isPro && user.role !== 'admin') {
            elements.proBanner.classList.remove('hidden');
          } else {
            elements.analyticsDashboard.classList.remove('hidden');
            elements.fetchPromptsSection.classList.remove('hidden');
            elements.supportBtn.classList.remove('hidden');
            elements.customCategoriesSection.classList.remove('hidden');
            elements.teamTagInput.classList.remove('hidden');
          }

          if (user.team) {
            elements.sidebar.classList.remove('hidden');
          }

          elements.grokApiKey.value = apiKeys.grok;
          elements.chatgptApiKey.value = apiKeys.chatgpt;
        } catch (e) {
          console.error('Error initializing UI:', e);
          showToast('Error initializing UI. Some features may not work.', 'bg-red-500');
        }
      }

      // Chart Management
      let chartInstance = null;
      function updateChart() {
        try {
          if (!elements.promptTrendChart) return;
          const dates = [...new Set(prompts.map(p => new Date(p.history[0]?.timestamp).toLocaleDateString()))];
          const counts = dates.map(date => 
            prompts.filter(p => new Date(p.history[0]?.timestamp).toLocaleDateString() === date).length
          );

          if (!chartInstance) {
            chartInstance = new Chart(elements.promptTrendChart, {
              type: 'line',
              data: {
                labels: dates,
                datasets: [{
                  label: 'Prompts Created',
                  data: counts,
                  borderColor: '#4f46e5',
                  backgroundColor: document.body.getAttribute('data-theme') === 'dark' ? 'rgba(79, 70, 229, 0.4)' : 'rgba(79, 70, 229, 0.2)',
                  fill: true,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
              }
            });
          } else {
            chartInstance.data.labels = dates;
            chartInstance.data.datasets[0].data = counts;
            chartInstance.data.datasets[0].backgroundColor = document.body.getAttribute('data-theme') === 'dark' ? 'rgba(79, 70, 229, 0.4)' : 'rgba(79, 70, 229, 0.2)';
            chartInstance.update();
          }
        } catch (e) {
          console.error('Error updating chart:', e);
        }
      }

      // Theme Management
      function initializeTheme() {
        try {
          const savedTheme = localStorage.getItem('theme') || 'light';
          document.body.setAttribute('data-theme', savedTheme);
          elements.themeToggle.innerHTML = `<i class="fas ${savedTheme === 'dark' ? 'fa-sun' : 'fa-moon'}"></i>`;
        } catch (e) {
          console.error('Error initializing theme:', e);
        }
      }

      // Category Management
      function renderCategories() {
        try {
          elements.categoryInput.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
          elements.categoryFilter.innerHTML = `<option value="">All Categories</option>` + categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
          elements.categoryList.innerHTML = categories.map(cat => `
            <li class="flex justify-between items-center bg-gray-100 p-2 rounded-md">
              ${cat}
              <button class="delete-category text-red-500 hover:text-red-700" data-category="${cat}" aria-label="Delete category ${cat}"><i class="fas fa-trash"></i></button>
            </li>
          `).join('');
          safeSetItem('categories', categories);
        } catch (e) {
          console.error('Error rendering categories:', e);
        }
      }

      // Optimized Prompt Rendering
      const memoizedRender = (() => {
        let lastFilter = '';
        let lastCategory = '';
        let lastPromptsHash = '';
        let lastTeamPromptsHash = '';
        let lastTeamActivityHash = '';

        function hashArray(arr) {
          return arr.map(item => JSON.stringify(item)).join('|');
        }

        return (filter = '', category = '') => {
          try {
            const promptsHash = hashArray(prompts);
            const teamPrompts = prompts.filter(p => p.category === 'Team' && p.shared);
            const teamPromptsHash = hashArray(teamPrompts);
            const teamActivityHash = hashArray(teamActivity.slice(-5));

            if (lastFilter === filter && lastCategory === category && 
                lastPromptsHash === promptsHash && 
                lastTeamPromptsHash === teamPromptsHash && 
                lastTeamActivityHash === teamActivityHash) {
              return;
            }

            lastFilter = filter;
            lastCategory = category;
            lastPromptsHash = promptsHash;
            lastTeamPromptsHash = teamPromptsHash;
            lastTeamActivityHash = teamActivityHash;

            // Update Prompt List
            const filteredPrompts = prompts.filter(p => 
              p.text.toLowerCase().includes(filter.toLowerCase()) &&
              (!category || p.category === category)
            );
            elements.promptList.innerHTML = filteredPrompts.map((p, i) => `
              <li class="bg-gray-50 p-4 rounded-md flex flex-col sm:flex-row justify-between items-start sm:items-center prompt-enter draggable" draggable="true" data-index="${i}">
                <div class="flex-1">
                  <span class="font-semibold text-indigo-600">[${p.category}]</span> ${p.text}
                  ${p.shared ? '<span class="ml-2 text-sm text-green-600">(Shared with Team)</span>' : ''}
                  ${p.tagged?.length ? `<span class="ml-2 text-sm text-blue-600">(Tagged: ${p.tagged.join(', ')})</span>` : ''}
                </div>
                <div class="mt-2 sm:mt-0 space-x-2">
                  ${user.isPro ? `<button class="view-history text-purple-500 hover:text-purple-700" data-index="${i}" aria-label="View history"><i class="fas fa-history"></i></button>` : ''}
                  <button class="edit-prompt text-blue-500 hover:text-blue-700" data-index="${i}" aria-label="Edit prompt"><i class="fas fa-edit"></i></button>
                  <button class="delete-prompt text-red-500 hover:text-red-700" data-index="${i}" aria-label="Delete prompt"><i class="fas fa-trash"></i></button>
                  ${user.team && p.category === 'Team' ? `<button class="toggle-share text-green-500 hover:text-green-700" data-index="${i}" aria-label="${p.shared ? 'Unshare' : 'Share'} with team"><i class="fas ${p.shared ? 'fa-user-slash' : 'fa-users'}"></i></button>` : ''}
                </div>
              </li>
            `).join('');

            // Update Team Prompts
            elements.teamPromptList.innerHTML = teamPrompts.map(p => `
              <li class="bg-indigo-100 p-2 rounded-md text-sm">
                ${p.text} ${p.tagged?.length ? `<span class="text-blue-600">(${p.tagged.join(', ')})</span>` : ''}
              </li>
            `).join('');

            // Update Team Activity
            elements.teamActivityList.innerHTML = teamActivity.slice(-5).reverse().map(a => `
              <li class="bg-gray-100 p-2 rounded-md text-sm">
                ${a.user} ${a.action} a prompt (${a.category}) at ${new Date(a.timestamp).toLocaleTimeString()}
              </li>
            `).join('');

            // Update Analytics (for Pro users)
            if (user.isPro) {
              elements.totalPrompts.textContent = prompts.length;
              elements.teamPrompts.textContent = teamPrompts.length;
              const categoriesCount = prompts.reduce((acc, p) => {
                acc[p.category] = (acc[p.category] || 0) + 1;
                return acc;
              }, {});
              const topCat = Object.entries(categoriesCount).sort((a, b) => b[1] - a[1])[0];
              elements.topCategory.textContent = topCat ? topCat[0] : 'None';
              updateChart();
            }
          } catch (e) {
            console.error('Error rendering UI:', e);
          }
        };
      })();

      // Setup Event Listeners
      function setupEventListeners() {
        try {
          // Theme Toggle
          elements.themeToggle.addEventListener('click', () => {
            try {
              const isDark = document.body.getAttribute('data-theme') === 'dark';
              const newTheme = isDark ? 'light' : 'dark';
              document.body.setAttribute('data-theme', newTheme);
              elements.themeToggle.innerHTML = `<i class="fas ${isDark ? 'fa-moon' : 'fa-sun'}"></i>`;
              localStorage.setItem('theme', newTheme);
              if (user.isPro) updateChart();
            } catch (e) {
              console.error('Error toggling theme:', e);
            }
          });

          // Sidebar Toggle
          elements.toggleSidebar.addEventListener('click', () => {
            try {
              elements.sidebar.classList.toggle('-translate-x-full');
            } catch (e) {
              console.error('Error toggling sidebar:', e);
            }
          });

          // Modal Management
          function closeHistoryModal() {
            try {
              elements.historyModal.classList.add('hidden');
            } catch (e) {
              console.error('Error closing history modal:', e);
            }
          }

          function closePreviewModal() {
            try {
              elements.previewModal.classList.add('hidden');
              elements.fetchQuery.value = '';
            } catch (e) {
              console.error('Error closing preview modal:', e);
            }
          }

          function closeApiSettingsModal() {
            try {
              elements.apiSettingsModal.classList.add('hidden');
            } catch (e) {
              console.error('Error closing API settings modal:', e);
            }
          }

          function closeSupportModal() {
            try {
              elements.supportModal.classList.add('hidden');
            } catch (e) {
              console.error('Error closing support modal:', e);
            }
          }

          elements.closeHistoryBtn.addEventListener('click', closeHistoryModal);
          elements.closePreviewBtn.addEventListener('click', closePreviewModal);
          elements.closeApiSettingsBtn.addEventListener('click', closeApiSettingsModal);
          elements.closeSupportBtn.addEventListener('click', closeSupportModal);

          // API Settings
          elements.apiSettingsBtn.addEventListener('click', () => {
            try {
              elements.apiSettingsModal.classList.remove('hidden');
            } catch (e) {
              console.error('Error opening API settings modal:', e);
            }
          });

          elements.saveApiSettingsBtn.addEventListener('click', () => {
            try {
              apiKeys.grok = elements.grokApiKey.value.trim();
              apiKeys.chatgpt = elements.chatgptApiKey.value.trim();
              safeSetItem('apiKeys', apiKeys);
              closeApiSettingsModal();
              showToast('API keys saved successfully!', 'bg-green-500');
            } catch (e) {
              console.error('Error saving API settings:', e);
            }
          });

          // Support
          elements.supportBtn.addEventListener('click', () => {
            try {
              elements.supportModal.classList.remove('hidden');
            } catch (e) {
              console.error('Error opening support modal:', e);
            }
          });

          elements.submitSupportBtn.addEventListener('click', () => {
            try {
              if (elements.supportIssue.value.trim().length < 10) {
                showToast('Please provide a detailed description (min 10 characters).', 'bg-red-500');
                return;
              }
              showToast('Support ticket submitted! Our team will respond within 1 hour.', 'bg-green-500');
              elements.supportIssue.value = '';
              closeSupportModal();
            } catch (e) {
              console.error('Error submitting support ticket:', e);
            }
          });

          // AI Prompt Fetching
          async function fetchAIPrompt(query, source) {
            try {
              await new Promise(resolve => setTimeout(resolve, 1000));
              if (!apiKeys[source]) {
                throw new Error(`No API key provided for ${source}`);
              }
              return [
                `${source.charAt(0).toUpperCase() + source.slice(1)}-generated prompt: Write a creative story about ${query}.`,
                `${source.charAt(0).toUpperCase() + source.slice(1)}-generated prompt: Analyze the impact of ${query} on modern society.`,
                `${source.charAt(0).toUpperCase() + source.slice(1)}-generated prompt: Create a poem inspired by ${query}.`
              ];
            } catch (e) {
              console.error('Error fetching AI prompt:', e);
              throw e;
            }
          }

          let selectedAIPrompts = [];
          elements.fetchPromptBtn.addEventListener('click', async () => {
            try {
              const query = elements.fetchQuery.value.trim();
              const source = elements.aiSource.value;

              if (query.length < 3) {
                showToast('Query must be at least 3 characters long.', 'bg-red-500');
                return;
              }

              showToast('Fetching prompts...', 'bg-blue-500');
              const aiPrompts = await fetchAIPrompt(query, source);
              elements.previewList.innerHTML = '';
              selectedAIPrompts = [];
              aiPrompts.forEach((prompt, i) => {
                const li = document.createElement('li');
                li.className = 'bg-gray-100 p-2 rounded-md flex items-center space-x-2';
                li.innerHTML = `
                  <input type="checkbox" id="aiPrompt${i}" class="h-4 w-4" aria-label="Select prompt ${i + 1}" />
                  <label for="aiPrompt${i}">${prompt}</label>
                `;
                elements.previewList.appendChild(li);
              });
              elements.previewModal.classList.remove('hidden');
            } catch (error) {
              console.error('Error in fetch prompt:', error);
              showToast(`Error fetching prompts: ${error.message}`, 'bg-red-500');
            }
          });

          elements.saveAIPrompts.addEventListener('click', () => {
            try {
              selectedAIPrompts = Array.from(elements.previewList.querySelectorAll('input:checked')).map(input => 
                input.nextElementSibling.textContent
              );
              if (selectedAIPrompts.length === 0) {
                showToast('Please select at least one prompt.', 'bg-red-500');
                return;
              }
              selectedAIPrompts.forEach(text => {
                prompts.push({
                  text,
                  category: elements.categoryInput.value,
                  shared: elements.categoryInput.value === 'Team' && user.team,
                  history: user.isPro ? [{ text, timestamp: new Date().toISOString() }] : [],
                  tagged: user.isPro && elements.teamTagInput.value.trim() ? [elements.teamTagInput.value.trim()] : []
                });
              });
              safeSetItem('prompts', prompts);
              memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
              showToast(`${selectedAIPrompts.length} AI prompt(s) saved!`, 'bg-green-500');
              closePreviewModal();
            } catch (e) {
              console.error('Error saving AI prompts:', e);
            }
          });

          // Category Management
          elements.addCategoryBtn.addEventListener('click', () => {
            try {
              const newCat = elements.newCategoryInput.value.trim();
              if (newCat.length < 1) {
                showToast('Category name cannot be empty.', 'bg-red-500');
                return;
              }
              if (categories.includes(newCat)) {
                showToast('Category already exists.', 'bg-red-500');
                return;
              }
              categories.push(newCat);
              renderCategories();
              elements.newCategoryInput.value = '';
              showToast('Category added successfully!', 'bg-green-500');
            } catch (e) {
              console.error('Error adding category:', e);
            }
          });

          function deleteCategory(category) {
            try {
              if (prompts.some(p => p.category === category)) {
                showToast('Cannot delete category with associated prompts.', 'bg-red-500');
                return;
              }
              categories = categories.filter(cat => cat !== category);
              renderCategories();
              showToast('Category deleted successfully!', 'bg-green-500');
            } catch (e) {
              console.error('Error deleting category:', e);
            }
          }

          elements.categoryList.addEventListener('click', (e) => {
            try {
              if (e.target.closest('.delete-category')) {
                const category = e.target.closest('.delete-category').dataset.category;
                deleteCategory(category);
              }
            } catch (e) {
              console.error('Error in category list click handler:', e);
            }
          });

          // Prompt Management
          elements.savePromptBtn.addEventListener('click', () => {
            try {
              const text = elements.promptInput.value.trim();
              const category = elements.categoryInput.value;
              const tagged = user.isPro && elements.teamTagInput.value.trim() ? [elements.teamTagInput.value.trim()] : [];

              if (text.length < 3) {
                showToast('Prompt must be at least 3 characters long.', 'bg-red-500');
                return;
              }

              if (!user.isPro && user.role !== 'admin' && prompts.length >= 3) {
                showToast('Upgrade to Pro to save more prompts!', 'bg-yellow-500');
                return;
              }

              const prompt = {
                text,
                category,
                shared: category === 'Team' && user.team,
                history: user.isPro ? [{ text, timestamp: new Date().toISOString() }] : [],
                tagged
              };
              prompts.push(prompt);
              safeSetItem('prompts', prompts);
              if (user.team && prompt.shared) {
                teamActivity.push({
                  user: user.name,
                  action: 'created',
                  category,
                  timestamp: new Date().toISOString()
                });
                safeSetItem('teamActivity', teamActivity);
              }
              elements.promptInput.value = '';
              elements.teamTagInput.value = '';
              memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
              showToast('Prompt saved successfully!', 'bg-green-500');
            } catch (e) {
              console.error('Error saving prompt:', e);
            }
          });

          function editPrompt(index) {
            try {
              const newText = prompt('Edit prompt:', prompts[index].text);
              if (newText && newText.trim().length >= 3) {
                if (user.isPro) {
                  prompts[index].history.push({ text: newText.trim(), timestamp: new Date().toISOString() });
                }
                prompts[index].text = newText.trim();
                safeSetItem('prompts', prompts);
                if (user.team && prompts[index].shared) {
                  teamActivity.push({
                    user: user.name,
                    action: 'edited',
                    category: prompts[index].category,
                    timestamp: new Date().toISOString()
                  });
                  safeSetItem('teamActivity', teamActivity);
                }
                memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
                showToast('Prompt updated successfully!', 'bg-green-500');
              } else if (newText !== null) {
                showToast('Prompt must be at least 3 characters long.', 'bg-red-500');
              }
            } catch (e) {
              console.error('Error editing prompt:', e);
            }
          }

          function deletePrompt(index) {
            try {
              if (confirm('Are you sure you want to delete this prompt?')) {
                const wasShared = prompts[index].shared;
                const category = prompts[index].category;
                prompts.splice(index, 1);
                safeSetItem('prompts', prompts);
                if (user.team && wasShared) {
                  teamActivity.push({
                    user: user.name,
                    action: 'deleted',
                    category,
                    timestamp: new Date().toISOString()
                  });
                  safeSetItem('teamActivity', teamActivity);
                }
                memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
                showToast('Prompt deleted successfully!', 'bg-green-500');
              }
            } catch (e) {
              console.error('Error deleting prompt:', e);
            }
          }

          function toggleShare(index) {
            try {
              prompts[index].shared = !prompts[index].shared;
              safeSetItem('prompts', prompts);
              if (user.team) {
                teamActivity.push({
                  user: user.name,
                  action: prompts[index].shared ? 'shared' : 'unshared',
                  category: prompts[index].category,
                  timestamp: new Date().toISOString()
                });
                safeSetItem('teamActivity', teamActivity);
              }
              memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
              showToast(prompts[index].shared ? 'Prompt shared with team!' : 'Prompt unshared.', 'bg-green-500');
            } catch (e) {
              console.error('Error toggling share:', e);
            }
          }

          function viewHistory(index) {
            try {
              elements.historyList.innerHTML = '';
              prompts[index].history.forEach((h, i) => {
                const li = document.createElement('li');
                li.className = 'bg-gray-100 p-2 rounded-md flex justify-between items-center';
                li.innerHTML = `
                  <div>
                    <span class="text-sm text-gray-500">${new Date(h.timestamp).toLocaleString()}</span><br>${h.text}
                  </div>
                  <button class="rollback-history text-blue-500 hover:text-blue-700" data-prompt="${index}" data-history="${i}" aria-label="Rollback to this version"><i class="fas fa-undo"></i></button>
                `;
                elements.historyList.appendChild(li);
              });
              elements.historyModal.classList.remove('hidden');
            } catch (e) {
              console.error('Error viewing history:', e);
            }
          }

          function rollbackHistory(promptIndex, historyIndex) {
            try {
              const oldText = prompts[promptIndex].text;
              prompts[promptIndex].text = prompts[promptIndex].history[historyIndex].text;
              prompts[promptIndex].history.push({ text: oldText, timestamp: new Date().toISOString() });
              safeSetItem('prompts', prompts);
              memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
              showToast('Prompt rolled back successfully!', 'bg-green-500');
              closeHistoryModal();
            } catch (e) {
              console.error('Error rolling back history:', e);
            }
          }

          // Event Delegation for Prompt Actions
          elements.promptList.addEventListener('click', (e) => {
            try {
              const target = e.target.closest('button');
              if (!target) return;
              const index = parseInt(target.dataset.index);
              if (target.classList.contains('view-history')) viewHistory(index);
              if (target.classList.contains('edit-prompt')) editPrompt(index);
              if (target.classList.contains('delete-prompt')) deletePrompt(index);
              if (target.classList.contains('toggle-share')) toggleShare(index);
            } catch (e) {
              console.error('Error in prompt list click handler:', e);
            }
          });

          elements.historyList.addEventListener('click', (e) => {
            try {
              const target = e.target.closest('.rollback-history');
              if (target) {
                rollbackHistory(parseInt(target.dataset.prompt), parseInt(target.dataset.history));
              }
            } catch (e) {
              console.error('Error in history list click handler:', e);
            }
          });

          // Export/Import
          elements.exportBtn.addEventListener('click', () => {
            try {
              const exportData = user.isPro ? prompts : prompts.map(({ text, category }) => ({ text, category }));
              const dataStr = JSON.stringify(exportData, null, 2);
              const blob = new Blob([dataStr], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'prompts.json';
              a.click();
              URL.revokeObjectURL(url);
              showToast('Prompts exported successfully!', 'bg-green-500');
            } catch (e) {
              console.error('Error exporting prompts:', e);
            }
          });

          elements.importInput.addEventListener('change', (e) => {
            try {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                  try {
                    const importedPrompts = JSON.parse(event.target.result);
                    if (Array.isArray(importedPrompts)) {
                      prompts.push(...importedPrompts);
                      safeSetItem('prompts', prompts);
                      memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
                      showToast('Prompts imported successfully!', 'bg-green-500');
                    } else {
                      showToast('Invalid file format.', 'bg-red-500');
                    }
                  } catch (e) {
                    console.error('Error parsing imported prompts:', e);
                    showToast('Error reading file.', 'bg-red-500');
                  }
                };
                reader.readAsText(file);
              }
              e.target.value = '';
            } catch (e) {
              console.error('Error importing prompts:', e);
            }
          });

          // Logout
          elements.logoutBtn.addEventListener('click', () => {
            try {
              localStorage.clear();
              showToast('Logged out successfully.', 'bg-green-500');
              setTimeout(() => window.location.href = 'login.html', 2000);
            } catch (e) {
              console.error('Error logging out:', e);
            }
          });

          // Search and Filter
          let searchTimeout;
          elements.searchInput.addEventListener('input', () => {
            try {
              clearTimeout(searchTimeout);
              searchTimeout = setTimeout(() => {
                memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
              }, 300);
            } catch (e) {
              console.error('Error in search input handler:', e);
            }
          });

          elements.categoryFilter.addEventListener('change', () => {
            try {
              memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
            } catch (e) {
              console.error('Error in category filter change handler:', e);
            }
          });

          // Drag-and-Drop
          let draggedItem = null;
          elements.promptList.addEventListener('dragstart', (e) => {
            try {
              if (e.target.classList.contains('draggable')) {
                draggedItem = e.target;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
              }
            } catch (e) {
              console.error('Error in dragstart handler:', e);
            }
          });

          elements.promptList.addEventListener('dragend', (e) => {
            try {
              if (e.target.classList.contains('draggable')) {
                e.target.classList.remove('dragging');
                draggedItem = null;
              }
            } catch (e) {
              console.error('Error in dragend handler:', e);
            }
          });

          elements.promptList.addEventListener('dragover', (e) => {
            try {
              e.preventDefault();
              e.dataTransfer.dropEffect = 'move';
            } catch (e) {
              console.error('Error in dragover handler:', e);
            }
          });

          elements.promptList.addEventListener('drop', (e) => {
            try {
              e.preventDefault();
              if (!draggedItem) return;
              const items = Array.from(elements.promptList.querySelectorAll('.draggable'));
              const dropTarget = e.target.closest('.draggable');
              if (!dropTarget || dropTarget === draggedItem) return;

              const oldIndex = parseInt(draggedItem.dataset.index);
              const newIndex = parseInt(dropTarget.dataset.index);
              const [movedPrompt] = prompts.splice(oldIndex, 1);
              prompts.splice(newIndex, 0, movedPrompt);
              safeSetItem('prompts', prompts);
              memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
            } catch (e) {
              console.error('Error in drop handler:', e);
            }
          });

          // Team Updates
          function checkForTeamUpdates() {
            try {
              const storedPrompts = safeGetItem('prompts', []);
              const storedActivity = safeGetItem('teamActivity', []);
              const promptsChanged = storedPrompts.length !== prompts.length || storedPrompts.some((p, i) => JSON.stringify(p) !== JSON.stringify(prompts[i]));
              const activityChanged = storedActivity.length !== teamActivity.length || storedActivity.some((a, i) => JSON.stringify(a) !== JSON.stringify(teamActivity[i]));

              if (promptsChanged || activityChanged) {
                prompts = storedPrompts;
                teamActivity = storedActivity;
                memoizedRender(elements.searchInput.value, elements.categoryFilter.value);
                showToast('Team prompts or activity updated!', 'bg-blue-500');
              }
            } catch (e) {
              console.error('Error checking for team updates:', e);
            }
          }

          // Commenting out setInterval to test
          // if (user.team) {
          //   setInterval(checkForTeamUpdates, 10000);
          // }
        }

        // Initialize
        try {
          initializeTheme();
          initializeUI();
          renderCategories();
          memoizedRender();
          setupEventListeners();
          clearTimeout(renderTimeout);
          loading.classList.add('hidden');
        } catch (e) {
          console.error('Error during initialization:', e);
          showToast('Failed to initialize the application. Please refresh.', 'bg-red-500');
          clearTimeout(renderTimeout);
          loading.classList.add('hidden');
        }
      })();
  </script>
</body>
</html>

